
# 分析检查清单

## 阶段1：信息收集

### 运行工具
- [ ] 执行 `cd ./blocksec-chrome && python main.py --chain-id {chain_id} --txn-hash {txn_hash}`
- [ ] 确认生成了以下文件：
  - [ ] `./Json_Report/{txn_hash}/report.md`
  - [ ] `./Json_Report/{txn_hash}/Vuln_function.md`
  - [ ] `./Json_Report/{txn_hash}/trace.md`
  - [ ] `./Json_Report/{txn_hash}/Code/` 目录

### 读取关键文件
- [ ] 读取 `report.md` 获取：
  - [ ] 攻击者地址
  - [ ] 受害者地址
  - [ ] 资金流向
  - [ ] 状态变化
- [ ] 读取 `Vuln_function.md` 获取：
  - [ ] 攻击者创建的合约列表
  - [ ] 攻击合约调用外部的函数（⚠️ 重点）
  - [ ] 函数源码和调用位置

## 阶段2：初步判断

### 避免常见错误
- [ ] ❌ 不要仅凭函数名判断漏洞（`increaseXXX`, `setXXX`, `transferXXX`）
- [ ] ✅ 追踪攻击者直接调用的第一个函数
- [ ] ✅ 关注 `external/public` 且无权限修饰符的函数

### 识别攻击模式
- [ ] 检查是否有闪电贷特征（大额借贷 + 还款）
- [ ] 检查是否有 Sandwich Attack 模式：
  - [ ] 前置交易（买入/卖出）
  - [ ] 中间交易（调用合约函数）
  - [ ] 后置交易（卖出/买入）
- [ ] 检查是否触发协议自动化机制：
  - [ ] Rebalancing
  - [ ] Liquidation
  - [ ] Arbitrage

## 阶段3：深度分析

### 函数分析
- [ ] 检查函数权限修饰符：
  - [ ] `onlyOwner`
  - [ ] `onlyAdmin`
  - [ ] `nonReentrant`
  - [ ] 其他自定义修饰符
- [ ] 分析函数参数：
  - [ ] 是否有参数验证
  - [ ] 攻击者传入的参数值
  - [ ] 参数是否异常（如合约全部余额）
- [ ] 检查函数副作用：
  - [ ] 是否向池子转入代币
  - [ ] 是否调用 `sync()` 更新储备量
  - [ ] 是否改变关键状态变量

### 资金流向验证
- [ ] 检查异常交易：
  - [ ] 大额代币换回很少价值
  - [ ] 流动性池规模异常
- [ ] 追踪代币流向：
  - [ ] 攻击者获利金额
  - [ ] 受害者损失金额
  - [ ] 中间交易手续费

### 代币经济系统
- [ ] 识别多代币系统结构（如 3-token）
- [ ] 找出价值出口（哪个代币可换稳定币/主币）
- [ ] 理解代币依赖关系

## 阶段4：生成报告

### 准备数据
- [ ] 提取交易哈希前4-6字符作为文件名
- [ ] 读取 `./Vuln/Vuln_Case.md` 模板
- [ ] 填充模板占位符

### 报告内容
- [ ] 使用 Mermaid 语法绘制攻击流程图
- [ ] 使用 Mermaid 语法绘制资金流向图
- [ ] 包含漏洞函数的完整分析
- [ ] 明确漏洞类型（CWE编号）
- [ ] 提供修复建议

### 质量检查
- [ ] 确认所有 Mermaid 代码块语法正确
- [ ] 验证数据准确性
- [ ] 保持报告简洁清晰
- [ ] 特别标注攻击合约调用外部的函数

## 常见陷阱提醒

### ⚠️ Valinity 案例教训
- 不要误判为"简单的价格操纵"
- 注意攻击者可能**抬高**价格而非降低
- 关注协议的自动化机制被触发

### ⚠️ MSCST 案例教训
- 不要过度关注"访问控制缺失"
- 重点是函数的**副作用**（向池子注入代币）
- 识别 Atomic Sandwich 模式的特征

### ⚠️ 路径问题
- 优先使用相对路径 `./Json_Report/`
- Code 目录按地址哈希分组，需递归搜索
- 使用 PowerShell 搜索文件实际位置
